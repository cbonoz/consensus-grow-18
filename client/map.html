<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- <link rel="icon" href="favicon.ico"> -->

    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <title>AnchorSupply</title>

    <style>
        #proof-section {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            text-overflow: ellipsis;
            -webkit-box-orient: vertical;
        }
        #date-section {
            font-style: italic;
        }

        #result-section {
            margin: 5px;
        }

        #error-text {
            color: red;
        }

        .map-header {
            margin-left: 20px;
            margin: 20px;
        }

        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            /*margin: 20px;*/
            width: 100%;
            height: 700px;
        }

        .card {
            /* Add shadows to create the "card" effect */
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            transition: 0.3s;
        }

        /* On mouse-over, add a deeper shadow */
        .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
        }

        /* Add some padding inside the card container */
        .container {
            padding: 2px 16px;
        }


    </style>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
          integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="css/product.css" rel="stylesheet">
</head>

<body>

<nav class="navbar navbar-expand-sm navbar-light bg-light">
    <a class="navbar-brand mx-4" href="index.html">
        <img style="max-width:35px;" class="navbar-left" src="img/logo.png">
        <strong>AnchorSupply</strong>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link mx-4 active" href="map.html"><strong>Map</strong></a>
            </li>
            <li class="nav-item">
                <a class="nav-link mx-4" href="api.html">API</a>
            </li>
            <li class="nav-item">
                <a class="nav-link mx-4" href="#">Sign Up</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container-fluid invisible viewpoint-fadeInUp">
    <div class="map-header">
        <h1>GrowNYC Dashboard:</h1>
        <span id="map-header-subtitle"></span>
        Date: <span id="date-section">
        </span>

        <div id="error-text"></div>
    </div>

    <div class="mx-auto" id="map"></div>
    <br/>
    <div class="row">
        <div class="column">
            <div id="result-section"></div>
        </div>
        <div class="column">
            <div id="proof-section"></div>
        </div>
    </div>
</div>
<hr>

<footer class="container py-4 mt-4">
    <div class="row">
        <div class="col-12 col-md">
          <span class="navbar-brand">
            <img style="max-width:35px; color: black;" class="navbar-left" src="img/logo.png">
            <strong>AnchorSupply</strong>
          </span>
            <span class="d-block mb-3 text-muted">&copy; 2018</span>
        </div>
        <div class="col-6 col-md">
            <h5>Features</h5>
            <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Map routing</a></li>
                <li><a class="text-muted" href="#">API docs</a></li>
                <li><a class="text-muted" href="#">Mobile app</a></li>
            </ul>
        </div>
        <div class="col-6 col-md">
            <h5>Map</h5>
            <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Schedule</a></li>
                <li><a class="text-muted" href="#">Vehicles</a></li>
                <li><a class="text-muted" href="#">Routing</a></li>
            </ul>
        </div>
        <div class="col-6 col-md">
            <h5>API</h5>
            <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Add an item</a></li>
                <li><a class="text-muted" href="#">Record a delivery</a></li>
                <li><a class="text-muted" href="#">Get the history of an item</a></li>
                <li><a class="text-muted" href="#">Optimal schedule</a></li>
            </ul>
        </div>
        <div class="col-6 col-md">
            <h5>About</h5>
            <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Team</a></li>
                <li><a class="text-muted" href="#">Privacy</a></li>
                <li><a class="text-muted" href="#">Terms</a></li>
            </ul>
        </div>
    </div>
</footer>
<!-- Placed at the end of the document so the pages load faster -->
<script
        src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous">
</script>

<style>
    .row {
        display: flex;
        padding: 20px;
    }

    .column {
        flex: 40%;
    }

    .column-75 {
        flex: 75%;
    }

    .column-25 {
        flex: 25%;
    }
</style>

<script>

    // This example creates a 2-pixel-wide red polyline showing the path of
    // the first trans-Pacific flight between Oakland, CA, and Brisbane,
    // Australia which was made by Charles Kingsford Smith.

    function initMap() {
        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3,
            center: {lat: 0, lng: -180},
            styles: [
                {
                    "elementType": "labels",
                    "stylers": [
                        {
                            "visibility": "off"
                        },
                        {
                            "color": "#f49f53"
                        }
                    ]
                },
                {
                    "featureType": "landscape",
                    "stylers": [
                        {
                            "color": "#f9ddc5"
                        },
                        {
                            "lightness": -7
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "stylers": [
                        {
                            "color": "#813033"
                        },
                        {
                            "lightness": 43
                        }
                    ]
                },
                {
                    "featureType": "poi.business",
                    "stylers": [
                        {
                            "color": "#645c20"
                        },
                        {
                            "lightness": 38
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "stylers": [
                        {
                            "color": "#1994bf"
                        },
                        {
                            "saturation": -69
                        },
                        {
                            "gamma": 0.99
                        },
                        {
                            "lightness": 43
                        }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#f19f53"
                        },
                        {
                            "weight": 1.3
                        },
                        {
                            "visibility": "on"
                        },
                        {
                            "lightness": 16
                        }
                    ]
                },
                {
                    "featureType": "poi.business"
                },
                {
                    "featureType": "poi.park",
                    "stylers": [
                        {
                            "color": "#645c20"
                        },
                        {
                            "lightness": 39
                        }
                    ]
                },
                {
                    "featureType": "poi.school",
                    "stylers": [
                        {
                            "color": "#a95521"
                        },
                        {
                            "lightness": 35
                        }
                    ]
                },
                {},
                {
                    "featureType": "poi.medical",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#813033"
                        },
                        {
                            "lightness": 38
                        },
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {},
                {
                    "elementType": "labels"
                },
                {
                    "featureType": "poi.sports_complex",
                    "stylers": [
                        {
                            "color": "#9e5916"
                        },
                        {
                            "lightness": 32
                        }
                    ]
                },
                {},
                {
                    "featureType": "poi.government",
                    "stylers": [
                        {
                            "color": "#9e5916"
                        },
                        {
                            "lightness": 46
                        }
                    ]
                },
                {
                    "featureType": "transit.station",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "transit.line",
                    "stylers": [
                        {
                            "color": "#813033"
                        },
                        {
                            "lightness": 22
                        }
                    ]
                },
                {
                    "featureType": "transit",
                    "stylers": [
                        {
                            "lightness": 38
                        }
                    ]
                },
                {
                    "featureType": "road.local",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#f19f53"
                        },
                        {
                            "lightness": -10
                        }
                    ]
                },
                {},
                {},
                {}
            ]
        });

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function createProofChain(item, proofs) {
            let text = "";
            text += `<h3>Delivery Chain</h3>`;

            text += `<h4><b>Selected: ${item.name}</b></h4><hr/>
            <h5>Supply Origin: ${item.origin}</h5>
            <h5>${item.unit}</h5>`;
            proofs.map((proof) => {
                const delivery = proof.delivery;
                text += `<div class="card" style="margin-bottom: 20px">
                    <div class="container">
                        <div class="row">
                        <span class="column-75">
                            <h4>Proof of Delivery</h4>
                             <i>Destination: ${delivery.name} - (${delivery.lat}, ${delivery.lng})</i>
                            <p><b>Hash</b>: ${proof.hashvalue}</p>
                            <p  style="max-width: 600px;"><b>Proof</b>: ${proof.proofvalue}</p>
                            </div>
                        <div class="column-25" >
                            <img src="img/check_mark.png" width="32"/>
                        </div>
                        </div>
                    </div>
                </div>`;
            });
            return text;
        }

//        const url = "http://13.65.170.101:9001";
        const url = "http://localhost:9001";

        function handleHistoryData(data, item) {
            console.log('handleHistoryData', data);
            const proofs = Object.keys(data.proofs).map((key) => {
                const d = data.proofs[key];
                d.delivery = data.deliveries[key];
                return d;
            });
            const text = createProofChain(item, proofs);
//            console.log(text);
            $('#proof-section').html(text)
        }

        function makeHistoryRequest(item) {
            const itemId = item.id;
            const historyUrl = `${url}/api/item/history/${itemId}`;
            $.ajax({
                url: historyUrl,
                type: 'GET',
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    handleHistoryData(response, item)
                },
                error: handleError
            });
        }

        function toggleBounce() {
            const marker = this;
            if (marker.getAnimation() !== null) {
                marker.setAnimation(null);
            } else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => {
                    marker.setAnimation(null);
                }, 1000)
            }
        }

        const startLocationId = 1;
        let markers;

        let firstRun = true;

        const icons = {
            pickup: './img/pickup.png',
            delivery: './img/delivery.png',
            start: './img/mto.png'
        };

        function handleError(res, textStatus, errorThrown) {
            console.log('handleError', textStatus, errorThrown);
            let message = `No Delivery Information available`;
//            if (res.status === 400) {
//                message = "Solution satisfying constraints not possible";
//            } else {
//                message = JSON.stringify(res);
//            }
            $("#error-text").html(message);
        }

        function getHistoryInfo(item) {
            makeHistoryRequest(item);
        }

        function getMarkerInfo(item, deliveryId, portName, pickup, stopNumber) {
            return `<div id="content">
<div id="siteNotice"></div><h1 id="firstHeading" class="firstHeading">${portName}</h1><div id="bodyContent">
<p><b>Item: ${item.name}</b></p>
<p><b>Location Name: ${portName}</b></p><p><b>Delivery ${deliveryId}</b></p><p>Stop Type: ${pickup ? 'Pickup' : 'Delivery'}, Stop Number ${stopNumber}</p></div></div>`;
        }

        function handleRouteData(data) {
            $("#error-text").html('');
            markers = [];
            console.log('data', data);
            const startLocationIndex = 0;

            const deliveries = data.deliveries;
            const items = data.items;
            const itemIds = Object.keys(deliveries);

            let routeText = `<p>Format: <b>Item (id #)</b>: {List of delivery locations}.</p>`;
            routeText += `<p>The first node indicates the product origin.</p>`;
            routeText += "<ul>";
            // choose arbitrarily the first item of the deliveries map to be the start location.
            const startLocation = deliveries[itemIds[0]][0];

            const bounds = new google.maps.LatLngBounds();

            markers.push(new google.maps.Marker({
                map: map,
                draggable: false,
                icon: icons.start,
                animation: firstRun ? google.maps.Animation.DROP : null,
                position: {lat: startLocation.lat, lng: startLocation.lng},
                optimized: false
            }));

            itemIds.map((itemId, vehicleIndex) => {
                const item = items[itemId];
                const itemName = item.name;
                const itemDeliveryMaps = [];
                itemDeliveryMaps.push({lat: startLocation.lat, lng: startLocation.lng});
                const route = deliveries[itemId];
                route.map((delivery, i) => {
                    const position = {lat: delivery.lat, lng: delivery.lng};
                    const name = delivery.name;
                    itemDeliveryMaps.push(position);
                    const isPickup = i === 0;
                    const markerName = `Delivery`;
                    const marker = new google.maps.Marker({
                        map: map,
                        draggable: false,
//                        icon: isPickup ? icons.pickup : icons.delivery,
                        animation: firstRun ? google.maps.Animation.DROP : null,
                        position: position,
                        title: markerName,
                        optimized: false
                    });

                    markers.push(marker);
                    marker.addListener('click', toggleBounce);
                    const infowindow = new google.maps.InfoWindow({
                        content: getMarkerInfo(item, delivery.id, markerName, isPickup, i)
                    });
                    marker.addListener('click', function () {
                        getHistoryInfo(item);
                        infowindow.open(map, marker);
                        setTimeout(() => {
                            infowindow.close();
                        }, 5000)
                    });

                });

                function formatLocation(r) {
                    const date = new Date(parseInt(r.timems));
                    const dateString = date.toLocaleString("en-US");
                    return `${dateString}: ${r.name} (${r.lat}, ${r.lng})`;
                }

                const startLocationFormatted = formatLocation(startLocation);
                const itemRoute = `<b>${itemName} (id: ${itemId}</b>):<br/> <span class="route-expanded" ${[startLocationFormatted].concat(route.map((r) => formatLocation(r))).join('<br/> - ')}</span>`;
                routeText += `<li onClick="">` + itemRoute + "</li>";
//                console.log(itemRoute);
                // itemDeliveryMaps.push({lat: startLocation.lat, lng: startLocation.lng});

                // Define a symbol using a predefined path (an arrow)
                // supplied by the Google Maps JavaScript API.
                let lineSymbol = {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
                };

                const color = getRandomColor();

                for (let i = 0, n = itemDeliveryMaps.length; i < n; i++) {

                    let coordinates = [];
                    for (let j = i; j < i + 2 && j < n; j++) {
                        coordinates[j - i] = itemDeliveryMaps[j];
                    }
                    let polyline = new google.maps.Polyline({
                        path: coordinates,
                        strokeColor: color,
                        strokeOpacity: 1.0,
                        strokeWeight: 3,
                        geodesic: true,
                        icons: [{
                            icon: lineSymbol,
                            offset: '100%'
                        }]
                    });
                    polyline.setMap(map);
                }
            });

            firstRun = false;
            routeText = `<h3>Today's Deliveries:</h3><hr/>` + routeText;
            $("#result-section").html(routeText);

            const lat = startLocation.lat;
            const lng = startLocation.lng;
            console.log('center', lat, lng);

            // Center the map at the starting node
//            const center = new google.maps.LatLng(lat, lng);
//            map.setCenter(center);
//            map.setZoom(11);
            markers.map((marker) => {
                loc = new google.maps.LatLng(marker.position.lat(), marker.position.lng());
                bounds.extend(loc);
            });
            map.fitBounds(bounds);
            map.panToBounds(bounds);
            map.setMapTypeId('satellite');

            $("#map-header-subtitle").html(`${itemIds.length} items active today -`)
        }

        const date = new Date();
        const jobDate = (date.getMonth() + 1) + '-' + date.getDate() + '-' + date.getFullYear();
        $("#date-section").html(jobDate);

        // vehicleCapacity 2 -> 'Dual Transactions'

        // TODO: fix problem where numVehicles*vehicleCapacity requiring to be > # nodes.
        const data = {};

        function makeRouteRequest(routeData) {
            console.log('makeRouteRequest');
            $.ajax({
                url: `${url}/api/deliveries`,
                type: 'GET',
                data: JSON.stringify(routeData),
                contentType: 'application/json; charset=utf-8',
                success: handleRouteData,
                error: handleError
            });
        }

        // Refresh the map page every 10000ms.
//        setInterval(makeRouteRequest, 10000);
        makeRouteRequest(data);

    }
</script>
<!-- Replace the value of the key parameter with your own API key. -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZv3FYTJL94Iob7eHNYHef3-obGTzpTcg&libraries=visualization&callback=initMap">
</script>

<!-- Bootstrap core JavaScript
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r69/three.min.js"></script>
<script src="js/animate-viewport.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-viewport-checker/1.8.8/jquery.viewportchecker.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
        integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
        integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>

<script>

</script>
</body>
</html>
